<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nexus - Pro Studio</title>
    
    <!-- Puter.js v2 -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- Markdown & Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --sidebar-bg: #1e293b;
            --chat-bg: #020617;
            --accent-primary: #6366f1; /* Indigo */
            --accent-hover: #4f46e5;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --user-bubble: #2563eb;
            --ai-bubble: #1e293b;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Inter, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
        }

        .login-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .login-btn:hover { transform: scale(1.05); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(to right, #6366f1, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        select {
            background-color: var(--bg-dark);
            color: white;
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            width: 100%;
        }
        select:hover { border-color: var(--accent-primary); }

        .btn-reset {
            background: transparent;
            border: 1px solid var(--border-color);
            color: #ef4444;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-reset:hover { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }

        /* --- CHAT AREA --- */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--chat-bg);
        }

        .header {
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(5px);
        }

        .model-badge {
            font-size: 0.8rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--accent-primary);
            color: #c7d2fe;
            padding: 4px 12px;
            border-radius: 20px;
        }

        /* Messages */
        #messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            scroll-behavior: smooth;
        }

        .msg-row {
            display: flex;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            animation: slideUp 0.3s ease;
        }
        .msg-row.user { justify-content: flex-end; }

        .avatar {
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }
        .avatar.ai { background: linear-gradient(135deg, #0ea5e9, #2563eb); }
        .avatar.user { background: var(--border-color); display: none; }

        .bubble {
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .msg-row.user .bubble {
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .msg-row.ai .bubble {
            background-color: var(--ai-bubble);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-bottom-left-radius: 2px;
            min-width: 100px;
        }

        /* --- MARKDOWN STYLES --- */
        .bubble h1, .bubble h2, .bubble h3 { margin-top: 10px; margin-bottom: 5px; color: white; }
        .bubble p { margin: 5px 0; }
        .bubble pre {
            background: #0d1117;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #30363d;
            margin: 10px 0;
        }
        .bubble code {
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }
        .bubble :not(pre) > code {
            background: rgba(255,255,255,0.1);
            padding: 2px 5px;
            border-radius: 4px;
            color: #e2e8f0;
        }
        .generated-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-top: 10px;
        }

        /* Input Area */
        .input-region {
            padding: 20px;
            background-color: var(--sidebar-bg);
            border-top: 1px solid var(--border-color);
        }
        
        .input-box {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            transition: border-color 0.2s;
        }
        .input-box:focus-within { border-color: var(--accent-primary); }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            max-height: 200px;
            padding: 10px;
            outline: none;
            height: 24px;
        }

        #send-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            width: 40px; height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        #send-btn:hover { background-color: var(--accent-hover); }
        #send-btn:disabled { background-color: #334155; cursor: not-allowed; }

        /* Loader */
        .dots { display: flex; gap: 4px; padding: 5px; }
        .dot { width: 6px; height: 6px; background: #aaa; border-radius: 50%; animation: pulse 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN (Fixes 401 Error) -->
    <div id="login-overlay">
        <div class="login-card">
            <h2><i class="fa-solid fa-lock"></i> Authentication Required</h2>
            <p style="color: #94a3b8; line-height: 1.5;">
                To use the AI models (Claude, GPT-4o) via Puter.js, you need to sign in.
                This allows the API to verify your request.
            </p>
            <button class="login-btn" onclick="signIn()">
                Sign In with Puter
            </button>
            <p id="login-status" style="margin-top:15px; font-size:0.9rem; color:#ef4444;"></p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-bolt"></i> AI Nexus
        </div>

        <div class="control-group">
            <div class="label">Mode</div>
            <select id="mode-select" onchange="toggleMode()">
                <option value="chat">ðŸ’¬ Chat & Coding</option>
                <option value="image">ðŸŽ¨ Image Generation</option>
            </select>
        </div>

        <div class="control-group" id="chat-models">
            <div class="label">AI Model</div>
            <select id="model-select" onchange="updateBadge()">
                <!-- Verified Model IDs -->
                <optgroup label="Best for Reasoning & Code">
                    <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="gpt-4o">GPT-4o (OpenAI)</option>
                    <option value="mistral-large-latest">Mistral Large</option>
                </optgroup>
                <optgroup label="Fast & Lightweight">
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                </optgroup>
            </select>
        </div>

        <div class="control-group" id="img-models" style="display:none;">
            <div class="label">Image Model</div>
            <select id="img-model-select">
                <option value="flux-schnell">Flux Schnell</option>
                <option value="sdxl">Stable Diffusion XL</option>
            </select>
        </div>

        <button class="btn-reset" onclick="clearChat()">
            <i class="fa-solid fa-trash"></i> Clear History
        </button>

        <div style="margin-top:10px; font-size:0.8rem; color:#64748b; text-align:center;">
            Logged in as: <span id="username-display">...</span>
        </div>
    </div>

    <!-- MAIN CHAT -->
    <div class="chat-container">
        <div class="header">
            <div style="font-weight:600">Session</div>
            <div class="model-badge" id="model-badge">Claude 3.5 Sonnet</div>
        </div>

        <div id="messages">
            <div class="msg-row ai">
                <div class="avatar ai"><i class="fa-solid fa-robot"></i></div>
                <div class="bubble">
                    <h3>Hello!</h3>
                    <p>I am connected and ready. Select <b>Claude 3.5 Sonnet</b> or <b>GPT-4o</b> from the left to start coding or chatting.</p>
                </div>
            </div>
        </div>

        <div class="input-region">
            <div class="input-box">
                <textarea id="user-input" rows="1" placeholder="Ask me anything..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION LOGIC ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginStatus = document.getElementById('login-status');
        const usernameDisplay = document.getElementById('username-display');

        async function checkAuth() {
            if (puter.auth.isSignedIn()) {
                const user = await puter.auth.getUser();
                usernameDisplay.innerText = user.username;
                loginOverlay.style.display = 'none'; // Unlock UI
            } else {
                loginOverlay.style.display = 'flex'; // Lock UI
            }
        }

        async function signIn() {
            try {
                loginStatus.innerText = "Connecting...";
                await puter.auth.signIn();
                await checkAuth(); // Re-check to unlock
            } catch (err) {
                loginStatus.innerText = "Login failed: " + err.message;
                console.error(err);
            }
        }

        // --- APP LOGIC ---
        let chatHistory = [];
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modeSelect = document.getElementById('mode-select');
        const modelSelect = document.getElementById('model-select');
        const imgModelSelect = document.getElementById('img-model-select');
        const badge = document.getElementById('model-badge');

        // Initialize Markdown & Highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            }
        });

        // Initialize on load
        window.addEventListener('load', checkAuth);

        function updateBadge() {
            if(modeSelect.value === 'chat') {
                badge.innerText = modelSelect.options[modelSelect.selectedIndex].text;
            }
        }

        function toggleMode() {
            const mode = modeSelect.value;
            if (mode === 'chat') {
                document.getElementById('chat-models').style.display = 'flex';
                document.getElementById('img-models').style.display = 'none';
                userInput.placeholder = "Ask a question or paste code...";
                updateBadge();
            } else {
                document.getElementById('chat-models').style.display = 'none';
                document.getElementById('img-models').style.display = 'flex';
                userInput.placeholder = "Describe the image to generate...";
                badge.innerText = "Text to Image";
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }

        function handleEnter(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function clearChat() {
            if(confirm("Clear conversation history?")) {
                chatHistory = [];
                messagesDiv.innerHTML = '';
                const resetMsg = document.createElement('div');
                resetMsg.className = 'msg-row ai';
                resetMsg.innerHTML = `<div class="avatar ai"><i class="fa-solid fa-robot"></i></div><div class="bubble"><p>Conversation cleared.</p></div>`;
                messagesDiv.appendChild(resetMsg);
            }
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- CORE SEND LOGIC ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if(!text) return;

            // 1. Reset Input
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 2. Display User Message
            addMessage('user', text);

            // 3. Create Loading Bubble
            const aiBubble = addLoadingBubble();
            const mode = modeSelect.value;

            try {
                if(mode === 'chat') {
                    // Chat Mode
                    chatHistory.push({ role: 'user', content: text });
                    
                    const modelId = modelSelect.value;
                    
                    // Streaming Call
                    const responseStream = await puter.ai.chat(chatHistory, { 
                        model: modelId, 
                        stream: true 
                    });

                    let fullResponse = "";
                    aiBubble.innerHTML = ""; // Clear loader

                    for await (const part of responseStream) {
                        fullResponse += part?.text || "";
                        aiBubble.innerHTML = marked.parse(fullResponse);
                        
                        // Highlight code blocks dynamically
                        aiBubble.querySelectorAll('pre code').forEach(block => {
                            hljs.highlightElement(block);
                        });
                        
                        scrollToBottom();
                    }
                    
                    chatHistory.push({ role: 'assistant', content: fullResponse });

                } else {
                    // Image Mode
                    const imgModel = imgModelSelect.value;
                    const imageEl = await puter.ai.txt2img(text);
                    
                    aiBubble.innerHTML = `<p>Generated with ${imgModelSelect.options[imgModelSelect.selectedIndex].text}:</p>`;
                    imageEl.className = 'generated-image';
                    aiBubble.appendChild(imageEl);
                }

            } catch (err) {
                console.error(err);
                aiBubble.innerHTML = `<p style="color:#f87171">Error: ${err.message || "Failed to connect to AI."}</p>`;
                if(err.message.includes('401')) {
                    checkAuth(); // Trigger login check if 401 happens mid-session
                }
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
                scrollToBottom();
            }
        }

        function addMessage(role, content) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            if(role === 'user') bubble.innerText = content;
            else bubble.innerHTML = content;

            if(role === 'ai') {
                row.innerHTML = `<div class="avatar ai"><i class="fa-solid fa-robot"></i></div>`;
                row.appendChild(bubble);
            } else {
                row.appendChild(bubble);
                row.innerHTML += `<div class="avatar user"><i class="fa-solid fa-user"></i></div>`;
            }

            messagesDiv.appendChild(row);
            scrollToBottom();
        }

        function addLoadingBubble() {
            const row = document.createElement('div');
            row.className = 'msg-row ai';
            row.innerHTML = `
                <div class="avatar ai"><i class="fa-solid fa-robot"></i></div>
                <div class="bubble">
                    <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                </div>
            `;
            messagesDiv.appendChild(row);
            scrollToBottom();
            return row.querySelector('.bubble');
        }
    </script>
</body>
</html>
